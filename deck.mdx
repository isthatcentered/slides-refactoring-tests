import {
  CodeSurfer,
  CodeSurferColumns,
  Step,
} from "code-surfer";
import {Image, Appear} from 'mdx-deck'
import { github, vsDark, shadesOfPurple, base } from "@code-surfer/themes";
import ciFailBadNamingSrc from "./static/test_with_bad_naming_run_fail.png"
import image from "./components/image"
import {Inline, Caption, Figure, EmojiSlide, TestsVsDevKnowledgeTable } from "./components"
export const theme = base;

export const splitCodeSampleProps = {themes: [vsDark, base]}

# Hello 👋
<Caption style={{ marginTop: -32 }}>Warning, lots of emojis</Caption>

---

<EmojiSlide caption="Clean code">
🛀📝
</EmojiSlide>  

<Notes>

- Tous les jours importance clean code

</Notes>

---

<EmojiSlide caption="Our code">  
<ul>
    <li>🤱</li>
    <Appear>
        <li key="1">🤏</li>
        <li key="2">👶</li>
        <li key="3">🌹</li>
    </Appear>
</ul>
</EmojiSlide>


<Notes>

- Prendre soin code
- Méthodes courtes
- Renommer encore methodes, class, variable 
- Jusqu''à ce que ça se lise comme poésie
- Et puis pourtants fichiers test:

</Notes>

---

<CodeSurfer>

```ts showNumbers
test("<Signup/>", async () => {
    const navigateSpy = jest.fn()
    ;(useNavigate as jest.Mock<typeof useNavigate>).mockImplementation(
        () => navigateSpy,
    )
    ;((User.createUser as any) as jest.MockInstance<
        ReturnType<typeof User.createUser>,
        any
    >).mockResolvedValue(null as any)
    ;((SocialLogin as any) as jest.MockInstance<
        ReturnType<typeof SocialLogin>,
        any
    >).mockImplementation(() => null)
    
    const page = render(<Signin />)
    
    const submitButton = page.getByRole("button", {
        name: /signin/i,
    }) as HTMLButtonElement
    
    fireEvent.click(submitButton)
    
    expect(() => page.getByText(/Login & password required/i)).not.toThrow()
    
    const email = page.getByLabelText(/email/i)
    fireEvent.change(email, { target: { value: "john@gmail.com" } })
    
    const password = page.getByLabelText(/password/i)
    fireEvent.change(password, { target: { value: "helloworld" } })
    
    fireEvent.click(submitButton)
    
    expect(() => page.getByText(/Loading/i)).not.toThrow()
    expect(submitButton.disabled).toBe(true)
    
    expect(User.createUser).toHaveBeenCalledWith({
        email: "john@gmail.com",
        password: "helloworld",
    })
    
    await tick()
    
    expect(navigateSpy).toHaveBeenCalledWith("/")
    
    expect(SocialLogin).toHaveBeenLastCalledWith(
        {
            loginEnpointRootUrl: API_BASE_URL,
        } as PropsType<typeof SocialLogin>,
        {},
    )

    // ... more
})
```

</CodeSurfer>

---

<EmojiSlide caption="I quit">  
    🏃‍♂️
</EmojiSlide>

<Notes>

- Moment ou souvient 18h, time to go home
- Moment ou test OFFICIELEMENT abandonné

</Notes>


---

# Refactoring tests

<Appear>
    <p>But why though ?</p>
</Appear>  

<Notes>

- Why
- J'ai des tests c'et pas suffisant ?

</Notes>

---



<EmojiSlide>
Tests = 🏃‍♂️📚
</EmojiSlide>  

<Notes>

- tests = spec executable
- Source de vérité:
- Comment chaque ecran app doit se comporter
- comment chaque edge case doit être géré

</Notes>

---

<TestsVsDevKnowledgeTable dev="🧩" tests="📚" result="😀" />

<Notes>

- Lors ajout feature/refactor 
- Permet concentrer / feature only
- Test watches for you
- = Avance + vite
- = + features
- = - bugs

<br/>

- pb arrive quand spec evolue/add feature
- Livraison à la priorité
- Donc si test trop compliqué
- Test abandonné

</Notes>

---

<TestsVsDevKnowledgeTable dev="🧩📕" tests="📗📘" result="😐" />

<Notes>

- test abandonné = pièce en + en tête cahque modif
- tendence inversée + en tête que ds tests

</Notes>

---


<TestsVsDevKnowledgeTable dev="🧩📕📗" tests="📘" result="😓" />

<Notes>

- Doit check manuellement de + en +

</Notes>

---

<TestsVsDevKnowledgeTable dev="🧩📚" tests="" result="🤯" />

<Notes>

- Jusque moment ou tendance complètement inversée
- Doit avoir l'ensemble de l'app en tête à chaque changement
- A chaque changement vous devez tout vérifier 

</Notes>

---

<EmojiSlide>
    <span>
        📈
    </span>
    <Appear>
        <span>
        😤 
        </span>
        <span>💸</span>
    </Appear>
</EmojiSlide>

<Notes>

- Can't keep all that in mind
- So bugs
- frutrated users
- lost money

</Notes>

---

<EmojiSlide>
    <span>
    👃
    </span>
    <Appear>
     <span>→ 👷‍♂️</span>
    </Appear>
</EmojiSlide>
  
<Notes>

- but aujourd'hui: 
- Identifier smells qui font test difficile maintenir
- Voir pistes pour faire mieux

</Notes>

   
<!-- 
🏗 + 💯 + 👌 + 🤸‍
- Structure 🏗
- Expressiveness 💯
- Feedback 👌
- Flexibility 🤸‍
-->

---


<EmojiSlide caption="Structural smells">🏗</EmojiSlide>


<Notes>

- Structure

- Si on veut que faciliter la contribution à nos tests,
- la première étape c'est que chacun ne réinvente pas la roue
- Voyage héros (HP, Roi lien, Matrix, Seigneur anneaux)
- Détails différents mais structure est la même
- Est-ce qu'on peut faire pareil

</Notes>

--- 

<!--
****************************
****************************
** 👃 UFOCUSED TESTS
****************************
****************************
-->

<EmojiSlide caption="Unfocused test">
🕺✅
</EmojiSlide>  

<Notes>

- Test qui part dans tous les sens

</Notes>

---

<CodeSurfer>

```js  showNumbers
test("<LoginPage/>", () => {
  const navigateSpy = spyOn(navigate)
  const page = render(<LoginPage/>)
  const email = page.getByLabel(/email/i)
  type(email, "credentials.email")
  expect(page.getByLabel(/submit/i)).not.ToBeInDom()
  const password = page.getByLabel(/password/i)
  type(password, "credentials.password")
  const submitButton = page.getByLabel(/submit/i)
  click(submitButton)
  expect(navigateSpy).toHaveBeenCalledWith("/")
})
```

```diff 2:4,7,9
```

```diff 5,8,10 showNumbers
```

```diff 6,11 showNumbers
```

```diff 
```

```js showNumbers 2:6 subtitle="Setup"
test("<LoginPage/>", () => {
  const navigateSpy = spyOn(navigate)
  const page = render(<LoginPage/>)
  const email = page.getByLabel(/email/i)
  const password = page.getByLabel(/password/i)
  const submitButton = page.getByLabel(/submit/i)
  type(email, "credentials.email")
  expect(page.getByLabel(/submit/i)).not.ToBeInDom()
  type(password, "credentials.password")
  click(submitButton)
  expect(navigateSpy).toHaveBeenCalledWith("/")
})
```

```js showNumbers 7:9 subtitle="Transformations"
test("<LoginPage/>", () => {
  const navigateSpy = spyOn(navigate)
  const page = render(<LoginPage/>)
  const email = page.getByLabel(/email/i)
  const password = page.getByLabel(/password/i)
  const submitButton = page.getByLabel(/submit/i)
  type(email, "credentials.email")
  type(password, "credentials.password")
  click(submitButton)
  expect(page.getByLabel(/submit/i)).not.ToBeInDom()
  expect(navigateSpy).toHaveBeenCalledWith("/")
})
```

```js showNumbers 6 10:11 subtitle='Verifications'
test("<LoginPage/>", () => {
  const navigateSpy = spyOn(navigate)
  const page = render(<LoginPage/>)
  const email = page.getByLabel(/email/i)
  const password = page.getByLabel(/password/i)
  const submitButton = page.getByLabel(/submit/i)
  type(email, "credentials.email")
  type(password, "credentials.password")
  click(submitButton)
  expect(page.getByLabel(/submit/i)).not.ToBeInDom()
  expect(navigateSpy).toHaveBeenCalledWith("/")
})
```

```diff showNumbers 2:6 subtitle="Arrange"
```

```diff showNumbers 7:9 subtitle="Act"
```

```diff showNumbers 10:11 subtitle="Assert"
```

```diff showNumbers 2:6 subtitle="Given"
```

```diff showNumbers 7:9 subtitle="When"
```

```diff showNumbers 10:11 subtitle="Then"
```

```js showNumbers 1:14
test("<LoginPage/>", () => {
  const navigateSpy = spyOn(navigate)
  const page = render(<LoginPage/>)
  const email = page.getByLabel(/email/i)
  const password = page.getByLabel(/password/i)
  const submitButton = page.getByLabel(/submit/i)

  type(email, "credentials.email")
  type(password, "credentials.password")
  click(submitButton)

  expect(page.getByLabel(/submit/i)).not.ToBeInDom()
  expect(navigateSpy).toHaveBeenCalledWith("/")
})
```


```diff 12  
```

```diff showNumbers 2:6,8:10,13  
```

```diff showNumbers  3,6,12
```

</CodeSurfer>

<Notes>

- Vérifie redirigé vers page d'accueil quand on se log
- Qu'est-ce qui fait test compliqué ?
- Mélange: [setup][actions][vérification]
- En gros, dur à suivre

<br/>

- Comment rendre plus clair ?
- Grouper par type  
- + add spaces
- SIGNAL: 2 AAA

</Notes>

---

Arrange, Act, Assert 

<Notes>

- AAA

</Notes>

---

<CodeSurferColumns {...splitCodeSampleProps}>

<Step>

```js showNumbers subtitle="Before"
test("<LoginPage/>", () => {
  const navigateSpy = spyOn(navigate)
  const page = render(<LoginPage/>)
  const email = page.getByLabel(/email/i)
  type(email, "credentials.email")
  expect(page.getByLabel(/submit/i)).not.ToBeInDom()
  const password = page.getByLabel(/password/i)
  type(password, "credentials.password")
  const submitButton = page.getByLabel(/submit/i)
  click(submitButton)
  expect(navigateSpy).toHaveBeenCalledWith("/")
})
```

```js showNumbers subtitle='After'
test("<LoginPage/>", () => {
  const navigateSpy = spyOn(navigate)
  const page = render(<LoginPage/>)
  const email = page.getByLabel(/email/i)
  const password = page.getByLabel(/password/i)
  const submitButton = page.getByLabel(/submit/i)

  type(email, "credentials.email")
  type(password, "credentials.password")
  click(submitButton)

  expect(page.getByLabel(/submit/i)).not.ToBeInDom()
  expect(navigateSpy).toHaveBeenCalledWith("/")
})
```

</Step>

</CodeSurferColumns>

<Notes>

- Idée rapide de ce que fait test
- Je sais ou trouver immediatement AAA
- Pas besoin de chercher 

</Notes>

---

<!--
****************************
****************************
** 👃 JUNK DRAWER
****************************
****************************
-->

👃: Junk drawer (🗑🗄)

<Notes>

- Fourre tout

</Notes>

---

<CodeSurfer>

```js showNumbers
test("<LoginPage/>", () => {
  // ...
}) 
```

```diff showNumbers 1[6:19] subtitle="Just one test for the whole page ?"
```

```js showNumbers
test("<LoginPage/>", () => {
  // verify can't submit if empty form

  // verify email validation
  
  // Verify password validation
    
  // verify loading state
    
  // verify login fail displays error
    
  // verify login fail redirect error

  // more stuff
}) 
```

</CodeSurfer>

<Notes>

- [click]
- Juste un test pour la page login ? [click]
- mhhhh

</Notes>

---

<CodeSurfer>

```js 1[6:39]
test("method -> condition -> behavior", ()=>{})
```

```js 1[6:18]
test("<LoginPage/> -> condition -> behavior", ()=>{})
```

```js 1[23:35]
test("<LoginPage/> -> failed login -> behavior", ()=>{})
```

```js 1[39:60]
test("<LoginPage/> -> failed login -> displays server error", ()=>{})
```

```js 1[7:54]
test("<LoginPage/> failed login displays server error", ()=>{})
```

```js subtitle="Grouping by method"
describe("<LoginPage/>", () => {
  test("Failed login displays server error", ()=>{})
}) 
```

```js 
describe("<LoginPage/>", () => {
  test("Invalid credentials displays server error", ()=>{})
  test("Pending submission displays loader", ()=>{})
  test("Successful login redirects to dashboard", ()=>{})
}) 
```

```js subtitle="Nesting tests by condition"
describe("<LoginPage/>", () => {
  describe("Failed login", () => {}) 
  describe("Invalid form", () => {})
  describe("Successful login", () => {})
}) 
```

```js subtitle="(Can help surfacing other requirements)"
describe("<LoginPage/>", () => {
  describe("Failed login", () => {
    test("Displays server error", ()=>{})
    test("Requires captcha on subsequent attempts", ()=>{})
    //...
  }) 
  describe("Invalid form", () => {})
  describe("Successful login", () => {})
}) 
```

</CodeSurfer>


---

# Use naming to scope

---

<CodeSurferColumns  {...splitCodeSampleProps}>

<Step>

```js showNumbers subtitle="before"
test("<LoginPage/>", () => {
    // verify can't submit if empty form
    
    // verify email validation
    
    // Verify password validation
    
    // verify loading state
    
    // verify login fail displays error
    
    // verify login fail redirect error
    
    // more stuff
}) 
```

```js subtitle="After" 
describe("<LoginPage/>", () => {
  test("Invalid credentials displays server error", ()=> {})
  test("Pending submission displays loader", ()=> {})
  test("Successful login redirects to dashboard", ()=> {})
}) 
```

</Step> 

</CodeSurferColumns>  

<Notes>

- Now we have battery of small focused test (B/A)
- We probably surfaced more edge cases

</Notes> 

---

"I don't care"

<Notes>

- Au delà difficulté à aborder test
- Side effect = useless ci

</Notes>

---

<!-- <Image  src={ciFailBadNamingSrc} alt="Tests with non specific names produce useless failures" >
</Image> -->
// IMG: Tests with non specific names produce useless failures

<Notes>

- Guess what the error is when you broke:
- Validation ?
- Redirection ?
- Error message ? 
- Yup

</Notes>

---

// IMG: Specific test names help reduce the debug area

<Notes>

- Can start investigating right away

</Notes>

---

<!--
****************************
****************************
** 👃 Unicorns everywhere
****************************
****************************
-->

👃: Unicorns everywhere (🦄🗺)

---

<CodeSurferColumns>

<Step>

```js subtitle="Service A" showNumbers
test("add() validation passed saves user to database", async () => {
  const db = await bootDb()
  const validator = new IdentityValidator()
  const user = makeUser({ ldap: 1234 })
  const repository = new UserRepository(db, validator)

  await repository.add(user)

  expect(await db.get("users").first()).toMatchObject(user)
}) 
```

```js subtitle="Service B" showNumbers
test("add() validation passed saves product to database", async () => {
  const db = { add: jest.fn() }
  const validator = { allows: jest.fn() }
  const product = "product"
  const repository = new ProductsRepository(db, validator)
  validator.mockResolvedValue(true)

  await repository.add(product)

  expect(db.add).toHaveBeenCalledWith("products", product)
}) 
```

</Step>

<Step>

```diff 2:4,9 subtitle="Real collaborators"
```

```diff
```

</Step>

<Step>

```diff 
```

```diff 2:4,6,10 subtitle="Mocks only"
```

</Step>

<Step>

```diff 4,7,9
```

```diff 4,8,10
```

</Step>

<Step>

```diff 
```

```diff 
```

</Step>

</CodeSurferColumns>

<Notes>

- Chacun fait comme il le sent sur le moment
- Contribuer = 20 mins à comprendre test first
- Suite 10 tests chacun complètement différent

</Notes>   

---


Stick to your guns

<Notes>

- Aka même type d'objet, même type de test

</Notes>


---

<CodeSurferColumns>

<Step>

```js subtitle="Service A" showNumbers
test("add() validation passed saves user to database", async () => {
    const db = { add: jest.fn() }
    const validator = { allows: jest.fn() }
    const user = "user"
    const repository = new ProductsRepository(db, validator)
    validator.mockResolvedValue(true)
    
    await repository.add(user)
    
    expect(db.add).toHaveBeenCalledWith("users", user)
}) 
```

```js subtitle="Service B" showNumbers
test("add() validation passed saves product to database", async () => {
  const db = { add: jest.fn() }
  const validator = { allows: jest.fn() }
  const product = "product"
  const repository = new ProductsRepository(db, validator)
  validator.mockResolvedValue(true)

  await repository.add(product)

  expect(db.add).toHaveBeenCalledWith("products", product)
}) 
```

</Step>

</CodeSurferColumns>

---

<!--
*****************************************************************************
*****************************************************************************
** Expressiveness 💯 *********************************************************
*****************************************************************************
*****************************************************************************
-->

# Expressiveness 💯

<Notes>

- Declarative vs imperative recipe
- Bon niveau de détail
- Communicate intent

</Notes>

--- 

<!--
****************************
****************************
** 👃 LOST IN DETAILS
****************************
****************************
-->

👃: Lost in details (📚🤔)

---

<CodeSurfer>

```js showNumbers 
test("<LoginPage/>", async () => {
    const credentials = {
       email: "brucewayne@wayneenterprises.com",
       password: "imbatman",
    }
    const page = render(<LoginPage />)
    const emailInput = page.getByLabelText(/email/i)
    const passwordInput = page.getByLabelText(/password/i)
    const submitButton = page.getByRole("button", { name: /login/i })
    when(login(credentials)).mockResolvedValue()
    
    fireEvent.change(emailInput, {
        target: { value: credentials.email },
    })
    fireEvent.change(passwordInput, { target: { value: credentials.password } })
    fireEvent.submit(submitButton)
    await new Promise(resolve => process.nextTick(resolve))
    
    expect(navigate).toHaveBeenCalledWith("/")
})
```

```diff 12:17 showNumbers
```

```diff 7,12:14 showNumbers 
```

```js showNumbers 
const type = (target, value, page) => {
  const input = page.getByLabelText(target)
  fireEvent.change(input, {
      target: { value },
  })
}

test("<LoginPage/>", async () => {
    const credentials = {
       email: "brucewayne@wayneenterprises.com",
       password: "imbatman",
    }
    const page = render(<LoginPage />)
    const emailInput = page.getByLabelText(/email/i)
    const passwordInput = page.getByLabelText(/password/i)
    const submitButton = page.getByRole("button", { name: /login/i })
    when(login(credentials)).mockResolvedValue()
    
    fireEvent.change(emailInput, {
        target: { value: credentials.email },
    })
    fireEvent.change(passwordInput, { target: { value: credentials.password } })
    fireEvent.submit(submitButton)
    await new Promise(resolve => process.nextTick(resolve))
    
    expect(navigate).toHaveBeenCalledWith("/")
})
```

```diff 1[30:34]
```

```js showNumbers 
const customRender = (component) => {
    const page = render(component)

    const type = (target, value) => {
      const input = page.getByLabelText(target)
      fireEvent.change(input, {
        target: { value },
      })
    }
  
    return {...page, type}
}

test("<LoginPage/>", async () => {
    const credentials = {
       email: "brucewayne@wayneenterprises.com",
       password: "imbatman",
    }
    const page = render(<LoginPage />)
    const emailInput = page.getByLabelText(/email/i)
    const passwordInput = page.getByLabelText(/password/i)
    const submitButton = page.getByRole("button", { name: /login/i })
    when(login(credentials)).mockResolvedValue()
    
    fireEvent.change(emailInput, {
        target: { value: credentials.email },
    })
    fireEvent.change(passwordInput, { target: { value: credentials.password } })
    fireEvent.submit(submitButton)
    await new Promise(resolve => process.nextTick(resolve))
    
    expect(navigate).toHaveBeenCalledWith("/")
})
```

```js showNumbers 
const customRender = (component) => {
    const page = render(component)

    const type = (target, value) => {
      const input = page.getByLabelText(target)
      fireEvent.change(input, {
        target: { value },
      })
    }
  
    return {...page, type}
}

test("<LoginPage/>", async () => {
    const credentials = {
       email: "brucewayne@wayneenterprises.com",
       password: "imbatman",
    }
    const page = customRender(<LoginPage />)
    const submitButton = page.getByRole("button", { name: /login/i })
    when(login(credentials)).mockResolvedValue()
    
    page.type(/email/i, "brucewayne@wayneenterprises.com" )
    page.type(/email/i, "imbatman" )
    fireEvent.submit(submitButton)
    await new Promise(resolve => process.nextTick(resolve))
    
    expect(navigate).toHaveBeenCalledWith("/")
})
```

```js showNumbers 
const customRender = (component) => {
    const page = render(component)

    const type = (target, value) => {
      const input = page.getByLabelText(target)
      fireEvent.change(input, {
        target: { value },
      })
    }
  
    const submit = (target) => {
      const element = page.getByRole("button", { name: /login/i } )
      fireEvent.submit(element)
    }

  
    return {...page, type, submit}
}

test("<LoginPage/>", async () => {
    const credentials = {
       email: "brucewayne@wayneenterprises.com",
       password: "imbatman",
    }
    const page = customRender(<LoginPage />)
    const submitButton = page.getByRole("button", { name: /login/i })
    when(login(credentials)).mockResolvedValue()
    
    page.type(/email/i, "brucewayne@wayneenterprises.com" )
    page.type(/email/i, "imbatman" )
    fireEvent.submit(submitButton)
    await new Promise(resolve => process.nextTick(resolve))
    
    expect(navigate).toHaveBeenCalledWith("/")
})
```

```js showNumbers 
const customRender = (component) => {
    const page = render(component)

    const type = (target, value) => {
      const input = page.getByLabelText(target)
      fireEvent.change(input, {
        target: { value },
      })
    }
  
    const submit = (target) => {
      const element = page.getByRole("button", { name: /login/i } )
      fireEvent.submit(element)
    }

  
    return {...page, type, submit}
}

test("<LoginPage/>", async () => {
    const credentials = {
       email: "brucewayne@wayneenterprises.com",
       password: "imbatman",
    }
    const page = customRender(<LoginPage />)
    when(login(credentials)).mockResolvedValue()
    
    page.type(/email/i, "brucewayne@wayneenterprises.com" )
    page.type(/email/i, "imbatman" )
    page.submit(/login/i)
    await new Promise(resolve => process.nextTick(resolve))
    
    expect(navigate).toHaveBeenCalledWith("/")
})
```

```js showNumbers 
const customRender = (component) => {
    const page = render(component)

    const type = (target, value) => {
      const input = page.getByLabelText(target)
      fireEvent.change(input, {
        target: { value },
      })
    }
  
    const submit = (target) => {
      const element = page.getByRole("button", { name: /login/i } )
      fireEvent.submit(element)
    }

    const waitForPendingPromisesToComplete = () => new Promise(resolve => process.nextTick(resolve))

  
    return {...page, type, submit, waitForPendingPromisesToComplete}
}

test("<LoginPage/>", async () => {
    const credentials = {
       email: "brucewayne@wayneenterprises.com",
       password: "imbatman",
    }
    const page = customRender(<LoginPage />)
    when(login(credentials)).mockResolvedValue()
    
    page.type(/email/i, "brucewayne@wayneenterprises.com" )
    page.type(/email/i, "imbatman" )
    page.submit(/login/i)
    await page.waitForPendingPromisesToComplete()
    
    expect(navigate).toHaveBeenCalledWith("/")
})
```

```diff 
```

```diff 27 
```

```diff 29:30 
```

```diff 31:32
```

```diff 34
```

```js showNumbers 
const customRender = (component) => {
    const page = render(component)

    const type = (target, value) => {
      const input = page.getByLabelText(target)
      fireEvent.change(input, {
        target: { value },
      })
    }
  
    const submit = (target) => {
      const element = page.getByRole("button", { name: /login/i } )
      fireEvent.submit(element)
    }

    const waitForPendingPromisesToComplete = () => new Promise(resolve => process.nextTick(resolve))

  
    return {...page, type, submit, waitForPendingPromisesToComplete}
}

const renderLoginPage = () => {
  const page = customRender(<LoginPage />)
  
  const allowLoginFor = (credentials) => when(login(credentials)).mockResolvedValue()

  const fillInLoginForm = (credentials) => {
      page.type(/email/i, credentials.email )
      page.type(/email/i, credentials.password )
  }

  const login = async () => {
    page.submit(/login/i)
    await page.waitForPendingPromisesToComplete()
  }

  return {...page, allowLoginFor, fillInLoginForm, login}
}

test("<LoginPage/>", async () => {
    const credentials = {
       email: "brucewayne@wayneenterprises.com",
       password: "imbatman",
    }
    const page = customRender(<LoginPage />)
    when(login(credentials)).mockResolvedValue()
    
    page.type(/email/i, "brucewayne@wayneenterprises.com" )
    page.type(/email/i, "imbatman" )
    page.submit(/login/i)
    page.waitForPendingPromisesToComplete()
    
    expect(navigate).toHaveBeenCalledWith("/")
})
```

```js showNumbers 
const customRender = (component) => {
    const page = render(component)

    const type = (target, value) => {
      const input = page.getByLabelText(target)
      fireEvent.change(input, {
        target: { value },
      })
    }
  
    const submit = (target) => {
      const element = page.getByRole("button", { name: /login/i } )
      fireEvent.submit(element)
    }

    const waitForPendingPromisesToComplete = () => new Promise(resolve => process.nextTick(resolve))

  
    return {...page, type, submit, waitForPendingPromisesToComplete}
}

const renderLoginPage = () => {
  const page = customRender(<LoginPage />)
  
  const allowLoginFor = (credentials) => when(login(credentials)).mockResolvedValue()

  const fillInLoginForm = (credentials) => {
      page.type(/email/i, credentials.email )
      page.type(/email/i, credentials.password )
  }

  const login = async () => {
    page.submit(/login/i)
    await page.waitForPendingPromisesToComplete()
  }

  return {...page, allowLoginFor, fillInLoginForm, login}
}

test("<LoginPage/>", async () => {
    const credentials = {
       email: "brucewayne@wayneenterprises.com",
       password: "imbatman",
    }
    const page = customRender(<LoginPage />)
    page.allowLoginFor(credentials)
    
    page.fillInLoginForm( credentials )
    await page.login()
    
    expect(navigate).toHaveBeenCalledWith("/")
})
```

</CodeSurfer>

<Notes>

- 5 sec to tell me what this is doing
- Hard, to understand even for someone that know the api
- Too many small pieces composed together
- Can't understand idea/concept behind
- How can we make that better ?

<br/>

- Framework is not for you
- Compose low level pieces into helpers
- Create page/item specific helpers to match domain
- Create page objects

</Notes>

---

What, not how

---

<CodeSurferColumns {...splitCodeSampleProps}>

<Step>

```js showNumbers 7:17 subtitle="Before" 
test("<LoginPage/>", async () => {
    const credentials = {
       email: "brucewayne@wayneenterprises.com",
       password: "imbatman",
    }
    const page = render(<LoginPage />)
    const emailInput = page.getByLabelText(/email/i)
    const passwordInput = page.getByLabelText(/password/i)
    const submitButton = page.getByRole("button", { name: /login/i })
    when(login(credentials)).mockResolvedValue()
    
    fireEvent.change(emailInput, {
        target: { value: credentials.email },
    })
    fireEvent.change(passwordInput, { target: { value: credentials.password } })
    fireEvent.submit(submitButton)
    await new Promise(resolve => process.nextTick(resolve))
    
    expect(navigate).toHaveBeenCalledWith("/")
})
```

```js showNumbers 6:10 subtitle="After" 
test("<LoginPage/>", async () => {
    const credentials = {
       email: "brucewayne@wayneenterprises.com",
       password: "imbatman",
    }
    const page = customRender(<LoginPage />)
    page.allowLoginFor(credentials)
    
    page.fillInLoginForm( credentials )
    await page.login()
    
    expect(navigate).toHaveBeenCalledWith("/")
})
```

</Step>

</CodeSurferColumns>

<Notes>

- Easy to understand
- Domain terms
- Centralized knowledge (bonus)

</Notes>

--- 

<!--
****************************
****************************
** 👃 SUSPICIOUS VALUES
****************************
****************************
-->

👃: Suspicious values (👮‍♂️📦)

<Notes>

- Valeurs suspectes

</Notes>

---

<CodeSurfer>

```js showNumbers
const count = 2
```

```js showNumbers
const date = "20/03/2018"
```

```js showNumbers 3:4 
test("<LoginPage/>", async () => {
    const credentials = {
       email: "brucewayne@wayneenterprises.com",
       password: "imbatman",
    }
    const page = renderLoginPage()
    page.allowLoginFor(credentials)
    
    page.fillInLoginForm(credentials)
    await page.login()
    
    expect(navigate).toHaveBeenCalledWith("/")
})
```

```js showNumbers 
test("<LoginPage/>", async () => {
    const credentials = {
       email: "credentials.email",
       password: "credentials.password",
    }
    const page = renderLoginPage()
    page.allowLoginFor(credentials)
    
    page.fillInLoginForm(credentials)
    await page.login()
    
    expect(navigate).toHaveBeenCalledWith("/")
})
```

```js showNumbers
    const route = WHATEVER
    const service = new SomeService(route)

    service.methodThatDoesntUseRoute()
```

</CodeSurfer>


<Notes>

- Why 2, why not 1
- And why not 0
- Whay "20/03/2018" why not 21st ?
- Does it really have to be a valid email ?
- If data shape doesn't matter, show it (credentials.email)
- If value doesn't matter at all, show it (WHATEVER) 

</Notes>

---

Make the unimportant obviously unimportant

---

<CodeSurferColumns {...splitCodeSampleProps}>

<Step>

```js showNumbers 2:5
test("<LoginPage/>", async () => {
    const credentials = {
       email: "brucewayne@wayneenterprises.com",
       password: "imbatman",
    }
    const page = renderLoginPage()
    page.allowLoginFor(credentials)
    
    page.fillInLoginForm(credentials)
    await page.login()
    
    expect(navigate).toHaveBeenCalledWith("/")
})
```

```js showNumbers 2:5
test("<LoginPage/>", async () => {
    const credentials = {
       email: "credentials.email",
       password: "credentials.password",
    }
    const page = renderLoginPage()
    page.allowLoginFor(credentials)
    
    page.fillInLoginForm(credentials)
    await page.login()
    
    expect(navigate).toHaveBeenCalledWith("/")
})
```

</Step>

</CodeSurferColumns>

<Notes>

- Clear that the value shape doesn't matter for this test
- If expectation on value passing, you'll get a better message (tracer object)

</Notes>

---

<!--
****************************
****************************
** 👃 EVERYTHING BOLD
****************************
****************************
-->

👃: Everything bold (🌏👨‍🦲)

---

<CodeSurfer>

```js showNumbers
test("Valiation success adds user to repository", () => {
    const user =  {
      firstname: "Bruce",
      lastname: "Wayne",
      email: "brucewayne@wayneenterprises.com",
      password: "admmin",
      ldap: "1234"
    }
    const validator = new IdentityValidator()
    const repository = new UserRepository(validator) 

    repository.add(user)

    expect(repository.all().first()).toMatchObject(user)
})
```

```diff 2:7
```

```diff 9
```

```diff
```

```js showNumbers subtitle="Factory"
const makeUser = (overrides) => ({
    firstname: "user.firstname",
    lastname: "user.lastname",
    email: "user.email",
    password: "user.password",
    ldap: "user.ldap",
  ...overrides
})

test("Valiation success adds user to repository", () => {
    const user =  {
      firstname: "Bruce",
      lastname: "Wayne",
      email: "brucewayne@wayneenterprises.com",
      password: "admmin",
      ldap: "1234"
    }
    const validator = new IdentityValidator()
    const repository = new UserRepository(validator) 

    repository.add(user)

    expect(repository.all().first()).toMatchObject(user)
})
```

```js showNumbers 11:14
const makeUser = (overrides) => ({
    firstname: "user.firstname",
    lastname: "user.lastname",
    email: "user.email",
    password: "user.password",
    ldap: "user.ldap",
  ...overrides
})

test("Valiation success adds user to repository", () => {
    const user =  makeUser({
      email: "brucewayne@wayneenterprises.com",
      ldap: "1234"
    })
    const validator = new IdentityValidator()
    const repository = new UserRepository(validator) 

    repository.add(user)

    expect(repository.all().first()).toMatchObject(user)
})
```

```diff 12:13
```

```js showNumbers subtitle="Named factory"
test("Valiation success adds user to repository", () => {
    const user =  makeUser.approvedByIdentity()
    const validator = new IdentityValidator()
    const repository = new UserRepository(validator) 

    repository.add(user)

    expect(repository.all().first()).toMatchObject(user)
})
```

</CodeSurfer>

<Notes>

- What in this user makes this test pass/fail
- I see a validator, so there's probably something going on
- I should be able to tell what
- How can we make that more obvious

</Notes>

---

Highlight what matters

---

<CodeSurferColumns {...splitCodeSampleProps}>

<Step>

```js showNumbers 2:8
test("Valiation success adds user to repository", () => {
    const user =  {
      firstname: "Bruce",
      lastname: "Wayne",
      email: "brucewayne@wayneenterprises.com",
      password: "admmin",
      ldap: "1234"
    }
    const validator = new IdentityValidator()
    const repository = new UserRepository(validator) 

    repository.add(user)

    expect(repository.all().first()).toMatchObject(user)
})
```

```js showNumbers 2:5
test("Valiation success adds user to repository", () => {
    const user =  makeUser({
      email: "brucewayne@wayneenterprises.com",
      ldap: "1234"
    })
    const validator = new IdentityValidator()
    const repository = new UserRepository(validator) 

    repository.add(user)

    expect(repository.all().first()).toMatchObject(user)
})
```

</Step>

</CodeSurferColumns>

---

<!--
****************************
****************************
** 👃 Duplicate naming
****************************
****************************
-->

👃: Duplicate naming (👶👶)

---

<CodeSurfer>

```js showNumbers
// Calls do something
doSomething()
```

```js showNumbers 2:5
test("Valiation success adds user to repository", () => {
    const user =  makeUser({
      email: "brucewayne@wayneenterprises.com",
      ldap: "1234"
    })
    const validator = new IdentityValidator()
    const repository = new UserRepository(validator) 

    repository.add(user)

    expect(repository.all().first()).toMatchObject(user)
})
```

```js showNumbers 2:5
test("Valiation success adds user to repository", () => {
    const identityApprovedUser =  makeUser({
      email: "brucewayne@wayneenterprises.com",
      ldap: "1234"
    })
    const validator = new IdentityValidator()
    const repository = new UserRepository(validator) 

    repository.add(user)

    expect(repository.all().first()).toMatchObject(user)
})
```

```js showNumbers 
test("Matching user in db returns match", async () => {
    const user1 =  makeUser({
      ldap: "user_1_ldap"
    })
    const user2 = makeUser({
      ldap: "user_2_ldap"
    })  
    const db = new Db()
    const repository = new UserRepository() 

    db.add("users", user1)
    db.add("users", user2)

    const found = await repository.get({ldap: user1.ldap})

    expect(found).toMatchObject(user1)
})
```

```diff 2:7
```

```js showNumbers 2[11:23],5[11:25],16
test("Matching user in db returns match", async () => {
    const matchingUser =  makeUser({
      ldap: "user_1_ldap"
    })
    const nonMatchingUser = makeUser({
      ldap: "user_2_ldap"
    })  
    const db = new Db()
    const repository = new UserRepository() 

    db.add("users", matchingUser)
    db.add("users", nonMatchingUser)

    const found = await repository.get({ldap: user1.ldap})

    expect(found).toMatchObject(matchingUser)
})
```

</CodeSurfer>

---

Put naming to work

--- 

<CodeSurferColumns {...splitCodeSampleProps}>

<Step>

```js showNumbers 2[11:16],5[11:16],16
test("Matching user in db returns match", async () => {
    const user1 =  makeUser({
      ldap: "user_1_ldap"
    })
    const user2 = makeUser({
      ldap: "user_2_ldap"
    })  
    const db = new Db()
    const repository = new UserRepository() 

    db.add("users", user1)
    db.add("users", user2)

    const found = await repository.get({ldap: user1.ldap})

    expect(found).toMatchObject(user1)
})
```

```js showNumbers 2[11:23],5[11:25],16
test("Matching user in db returns match", async () => {
    const matchingUser =  makeUser({
      ldap: "user_1_ldap"
    })
    const nonMatchingUser = makeUser({
      ldap: "user_2_ldap"
    })  
    const db = new Db()
    const repository = new UserRepository() 

    db.add("users", matchingUser)
    db.add("users", nonMatchingUser)

    const found = await repository.get({ldap: user1.ldap})

    expect(found).toMatchObject(matchingUser)
})
```

</Step>

</CodeSurferColumns>

---

<!--
****************************
****************************
** 👃 MYSTERY GUEST
****************************
****************************
-->

👃: Mystery guest (👻🎁)

<Notes>


</Notes>

---

returns first item in table
bootdb -> expect(usersTable.first().name).toBe("john")

---

Feedback 👌 

<Notes>

- When fail, in ci/during refactor 
- Don't want to waste time understanding failure
- Failure should be expressive enough to tell you clearly what was expected and what happened
- Otherwise, time lost 
- Like undefined is not a function
- True, but I still have no clue what the problem is
- Failures should give you clues, breadcrumbs on the path to solving a bug
see justin searls

</Notes>

---

<!--
****************************
****************************
** 👃 NAN
****************************
****************************
-->

👃: Not a number (🎰)

<Notes>

- Ever had that error
- Not quite useful right 
- Like undefined is not a function
- True, but I still have no clue what the problem is

</Notes>

---

<CodeSurfer>

```bash 
🛑 Fail: "chars() returns every char in string"
        
         Error: expected( 0 ).toBe( 5 ) 
```

```js showNumbers 3
test("chars() returns every char in string", () => {
  // ...stuff
  expect(chars(string).length).toBe(5)
})
```

```js showNumbers 3
test("chars() returns every char in string", () => {
  // ...stuff
  expect(chars(string)).toHaveLength(5)
})
```

```bash 
🛑 Fail: "chars() returns every char in string"
        
         Error: expect(received).toHaveLength(expected)
         
         Expected length: 10
         Received length: 0
         Received array:  []
```

```bash 
🛑 Fail: "Cannot re-submit form until post completion"
        
         Error: expect(received).toBe(expected) // Object.is equality
         
         Expected: false
         Received: true
```


```js showNumbers 3
test("Cannot re-submit form until post completion", () => {
  // ...stuff
  expect(button.disabled).toBe(true)
})
```

```js showNumbers 3
test("Cannot re-submit form until post completion", () => {
  // ...stuff
  expect(button).toBeDisabled()
})
```

```bash 
🛑 Fail: "Cannot re-submit form until post completion"
        
         Error: expect(element).toBeDisabled()
         
         <button /> is not disabled:
```

</CodeSurfer>

---

Leverage matchers

---

<CodeSurferColumns {...splitCodeSampleProps}>

<Step>

```bash 
🛑 Fail: "chars() returns every char in string"
        
         Error: expected( 0 ).toBe( 5 ) 
```

```bash 
🛑 Fail: "chars() returns every char in string"
        
         Error: expect(received).toHaveLength(expected)
         
         Expected length: 10
         Received length: 0
         Received array:  []
```

</Step>

</CodeSurferColumns>

---

<!--
****************************
****************************
** 👃 Memory dump
****************************
****************************
-->

👃: Memory dump (🧠🗑)

<Notes>


</Notes>

---

<CodeSurfer>

```bash
🛑 Fail: "Returns users sorted by id descending"
        Error: expect(received).toEqual(expected) // deep equality
        
        - Expected
        + Received
        
        @@ -4,11 +4,11 @@
                "city": "user.address.city",
                "street": "user.address.city",
              },
              "birthdate": "user.birthdate",
              "firstname": "user.firstname",
        -     "id": 3,
        +     "id": 1,
              "lastname": "user.lastname",
            },
            Object {
              "address": Object {
                "city": "user.address.city",
        @@ -24,9 +24,9 @@
                "city": "user.address.city",
                "street": "user.address.city",
              },
              "birthdate": "user.birthdate",
              "firstname": "user.firstname",
        -     "id": 1,
        +     "id": 3,
              "lastname": "user.lastname",
            },
          ]
```

```js showNumbers
test(`Orders users by id descending`, () => {
  // ...stuff

  const result = orderUsers(users)

  expect(result).toEqual([user3, user2, user1])
})
```

```js showNumbers 
test(`Orders users by id descending`, () => {
  // ...stuff

  const result = orderUsers(users).map(prop("id"))
  
  expect(result).toEqual([3, 2, 1])
})
```

```diff 4[35:51],6[26:35]
```

```bash
🛑 Fail: "Returns users sorted by id descending"
        Error: expect(received).toEqual(expected) // deep equality
        
        - Expected
        + Received
        
          Array [
        -   3,
        -   2,
            1,
        +   2,
        +   3,
          ]
```

```bash
🛑 Fail: "Gets user by id"
        Error: expect(received).toBe(expected) // Object.is equality
        
        - Expected
        + Received
        
        @@ -2,9 +2,9 @@
            "address": Object {
              "city": "user.address.city",
              "street": "user.address.city",
            },
            "birthdate": "user.birthdate",
        -   "firstname": "John",
        -   "id": 2,
        +   "firstname": "Bob",
        +   "id": 1,
            "lastname": "user.lastname",
          }
```

```js
test(`Gets user by id`, async () => {
    // ...stuff

    const result = await repository.get(user2.id)

    expect(result).toBe(user2)
})
```

```js
test(`Gets user by id`, async () => {
    // ...stuff

    const result = await repository.get(user2.id)

    expect(result.firstname).toBe(user2.firstname)
})
```

```bash
🛑 Fail: "Gets user by id"
        Error: expect(received).toBe(expected) // Object.is equality
        
        Expected: "John"
        Received: "Bob"
```

</CodeSurfer>

---

<!--
****************************
****************************
** 👃 TRACE FAIL
****************************
****************************
-->

👃: Trace fail (🗺😢)

<Notes>

- You just want to test delegaton
- That something has been passed to something else

</Notes>

---

<CodeSurfer>

```bash
🛑 Fail: "Saves user to database"
        Error: expect(jest.fn()).toHaveBeenCalledWith(...expected)
        
        Expected: {"address": {"city": "address.city", "street": "address.city"}, "birthdate": "birthdate", "firstname": "firstname", "lastname": "lastname"}
        Received: undefined
```

```js 2,6,8
test(`Saves user in database c`, async () => {
    const user = withDescription(makeUser(), "user")
    const db = { add: jest.fn() }
    const repository = new UserRepository(db)
    
    await repository.create(user)
    
    expect(db.add).toHaveBeenCalledWith(user)
})
```

```js
test(`Saves user in database c`, async () => {
    const user = "user"
    const db = { add: jest.fn() }
    const repository = new UserRepository(db)
    
    await repository.create(user)
    
    expect(db.add).toHaveBeenCalledWith(user)
})
```

```bash
🛑 Fail: "Saves user to database"
        Error: expect(jest.fn()).toHaveBeenCalledWith(...expected)
        
        Expected: "user"
        Received: undefined
```

</CodeSurfer>

---

Use placeholders

---

<CodeSurferColumns {...splitCodeSampleProps}>

<Step>

```bash
🛑 Fail: "Saves user to database"
        Error: expect(jest.fn()).toHaveBeenCalledWith(...expected)
        
        Expected: {"address": {"city": "address.city", "street": "address.city"}, "birthdate": "birthdate", "firstname": "firstname", "lastname": "lastname"}
        Received: undefined
```

```bash
🛑 Fail: "Saves user to database"
        Error: expect(jest.fn()).toHaveBeenCalledWith(...expected)
        
        Expected: "user"
        Received: undefined
```

</Step>

</CodeSurferColumns>

---

<CodeSurfer>




```js 1:2,3[8:10] title="Focus 🤓"
console.log(1);

console.log(2);
console.log(3);
```

</CodeSurfer>

---

<CodeSurfer>

```js title="steps"
console.log(1);
console.log(2);
console.log(3);
```

```js 1
console.log(1);
console.log(2);
console.log(3);
```

```js
console.log(1);
console.log(2);
console.log(3);
console.log(4);
console.log(5);
```

</CodeSurfer>

---

<CodeSurferColumns {...splitCodeSampleProps}>

<Step title="Columsn: First Step">

```js
console.log(1);
console.log(2);
```

```js
console.log("a");
console.log("b");
```

</Step>

<Step title="Columns: Second Step">

```js 2
console.log(1);
console.log(2);
```

```js 2
console.log("a");
console.log("b");
```

</Step>

</CodeSurferColumns>

---

<CodeSurfer title="diffs">

```js
console.log(1);
console.log(2);
console.log(3);
```

```diff 1 subtitle="log 1"


```

```diff 2 subtitle="log 2"

```

```diff 3 subtitle="log 3"

```

</CodeSurfer>

---

<CodeSurfer>

```js title="This is a title" subtitle="and this a subtitle"
function lorem(ipsum, dolor = 1) {
  const sit = ipsum == null ? 0 : ipsum.sit;
  dolor = sit - amet(dolor);
  return sit
    ? consectetur(ipsum, 0, dolor < 0 ? 0 : dolor)
    : [];
}

function incididunt(ipsum, ut = 1) {
  ut = labore.et(amet(ut), 0);
  const sit = ipsum == null ? 0 : ipsum.sit;

  if (!sit || ut < 1) {
    return [];
  }

  let dolore = 0;
  let magna = 0;
  const aliqua = new eiusmod(labore.ut(sit / ut));

  while (dolore < sit) {
    aliqua[magna++] = consectetur(
      ipsum,
      dolore,
      (dolore += ut)
    );
  }

  return aliqua;
}
```

```js
function lorem(ipsum, dolor = 1) {
  const sit = ipsum == null ? 0 : ipsum.sit;
  dolor = sit - amet(dolor);
  return sit
    ? consectetur(ipsum, 0, dolor < 0 ? 0 : dolor)
    : [];
}

function adipiscing(...elit) {
  if (!elit.sit) {
    return [];
  }

  const sed = elit[0];
  return eiusmod.tempor(sed) ? sed : [sed];
}

function incididunt(ipsum, ut = 1) {
  ut = labore.et(amet(ut), 0);
  const sit = ipsum == null ? 0 : ipsum.sit;

  if (!sit || ut < 1) {
    return [];
  }

  let dolore = 0;
  let magna = 0;
  const aliqua = new eiusmod(labore.ut(sit / ut));

  while (dolore < sit) {
    aliqua[magna++] = consectetur(
      ipsum,
      dolore,
      (dolore += ut)
    );
  }

  return aliqua;
}
```

```diff 1[10:14],2[15:19],3[22:27],10:12

```

</CodeSurfer>

---

<CodeSurferColumns themes={[vsDark, github]}>

<Step>

```js
const magna = aliqua => aliqua.ut((enim, ad) => enim, 0);
```

```js
const minim = (ad, enim) => dolore.magna(ad / enim);
```

</Step>

<Step>

```js
const lorem = (ipsum, dolor, sit) => {
  const amet = dolor - ipsum;
  return consectetur.adipiscing(
    {
      elit: sed.eiusmod(sit - dolor) / amet + 2,
    },
    (tempor, incididunt) => ipsum + amet * incididunt
  );
};

const magna = aliqua => aliqua.ut((enim, ad) => enim, 0);
```

```js
const minim = (ad, enim) => dolore.magna(ad / enim);

const sed = (eiusmod, tempor, incididunt) => {
  const ut = tempor - eiusmod;
  return labore.et(
    {
      amet: dolore.magna(incididunt - tempor) / ut + 2,
    },
    (aliqua, elit) => eiusmod + ut * elit
  );
};
```

</Step>

</CodeSurferColumns>

---

docs:  
[codesurfer.pomb.us](https://codesurfer.pomb.us)
